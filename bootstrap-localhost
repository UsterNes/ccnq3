#!/usr/bin/env bash

set -e
export LANG=
SRC="`pwd`"

./bootstrap/prepare
./bootstrap/node
(cd && sudo npm -g install coffee-script)
(cd && npm install request)

# (cd && npm install "${SRC}/"lib/cdb)
# (cd && npm install "${SRC}/"lib/cdb_changes)
# Install the versions from the registry:
(cd && npm install cdb cdb_changes)

echo "*** Install the host agent"
(cd && npm install "${SRC}/"applications/host)

# Start application/host
MAIN_URI="$1"
shift

sudo mkdir -p /etc/ccnq3
sudo tee /etc/ccnq3/host.config <<"JSON" >/dev/null
{
  "provisioning_couchdb_uri": "${MAIN_URI}/provisioning"
}
JSON

npm stop  ccnq3_host || echo
npm start ccnq3_host
