#!/usr/bin/env bash

set -e
export LANG=
SRC="`pwd`"

sudo mkdir -p /etc/ccnq3
if [ -e /etc/ccnq3/bootstrap.config ]; then
  echo "** This host is a bootstrap host, please do not run this script."
  exit
fi

if [ "x$1" == "x" ]; then
  echo "** You must provide a reference URI."
  exit
fi

if [ -e /etc/ccnq3/host.config ]; then
  echo "** WARNING: This host has already been bootstrapped. Configuration will be overwritten."
fi

./bootstrap/prepare
./bootstrap/node
(cd && sudo npm -g install coffee-script)
(cd && npm install request)

# (cd && npm install "${SRC}/"lib/cdb)
# (cd && npm install "${SRC}/"lib/cdb_changes)
# Install the versions from the registry:
(cd && npm install cdb cdb_changes)

echo "*** Install the host agent"
(cd && npm install "${SRC}/"applications/host)

# Start application/host
MAIN_URI="$1"
shift

sudo tee /etc/ccnq3/host.config <<"JSON" >/dev/null
{
  "provisioning_couchdb_uri": "${MAIN_URI}/provisioning"
}
JSON

npm stop  ccnq3_host || echo
npm start ccnq3_host
