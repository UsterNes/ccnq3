#!/usr/bin/env bash

set -e
export LANG=
SRC="`pwd`"
DIR=/etc/ccnq3
CONF=${DIR}/host.json

./bootstrap/prepare
./bootstrap/node

HOSTNAME=`hostname`

sudo mkdir -p "${DIR}"
if [ -e "${CONF}" ]; then
  echo "** WARNING: This host has already been bootstrapped. The previous configuration will be used. To start over please remove ${CONF} before using this script."
else
  if [ "x$1" == "x" ]; then
    echo "** You must provide a reference URI."
    exit
  else
    URI=$1
    shift
  fi

  # make_id
  sudo tee "${CONF}" <<JSON >/dev/null
  {
    "_id": "host:${HOSTNAME}",
    "type": "host",
    "host": "${HOSTNAME}",
    "provisioning": {
      "couchdb_uri": "$URI"
    }
  }
JSON
  sudo chown `whoami` "${CONF}"

  sudo tee "${DIR}/applications" <<TEXT >/dev/null
applications/host
# Add any server-specific applications here.
TEXT
  sudo chown `whoami` "${DIR}/applications"

fi

${SRC}/cleanup
${SRC}/update-localhost
${SRC}/restart

echo "==== Done ===="
