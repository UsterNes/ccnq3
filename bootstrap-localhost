#!/usr/bin/env bash
# (c) 2011 Stephane Alnet
# License: APGL3+

set -e
export LANG=
SRC="`pwd`"
DIR=/etc/ccnq3
CONF=${DIR}/host.json

if [ -e "${CONF}" ]; then
  echo "** ERROR: $CONF already exists **"
  exit 1
fi

./bootstrap/prepare
./bootstrap/node

HOSTNAME=`hostname`

echo "Create ${DIR}"
sudo mkdir -p "${DIR}"
sudo chown `whoami` "${DIR}"

if [ "x$1" == "x" ]; then
  echo "** ERROR: You must provide a reference URI **"
  exit
fi

echo "Creating ${CONF}"
curl -o "${CONF}" "$1"

# Add any server-specific applications at the end of the (space-delimited) string.
sudo chown `whoami` "${CONF}"

echo "Cleanup"
${SRC}/cleanup

echo "Install dependencies"
(cd && cd "${SRC}" \
    && npm install )

echo "Update"
(cd && cd "${SRC}" \
    && npm run-script updates)

echo "Restart"
(cd && cd "${SRC}" \
    && npm restart)

echo "Installation done."
