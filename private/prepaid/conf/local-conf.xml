<!-- Prepaid profile -->
<X-PRE-PROCESS cmd="set" data="profile_name=$${prepaid_profile_name}"/>
<X-PRE-PROCESS cmd="set" data="profile_type=$${prepaid_profile_type}"/>
<X-PRE-PROCESS cmd="set" data="egress_target=$${prepaid_egress_target}"/>
<X-PRE-PROCESS cmd="set" data="ingress_target=$${prepaid_ingress_target}"/>

<section name="dialplan" description="Regex/XML Dialplan">

<X-PRE-PROCESS cmd="include" data="dialplan/client-sbc.xml.template"/>

<context name="egress-$${profile_name}-$${profile_type}-send-call">
  <extension name="send-call">
    <condition field="${ccnq_account}" expression="^.+$"/> <!-- Must be present -->
    <condition field="destination_number" expression="^(.*)$">
      <action application="set" data="prepaid_uri=$${prepaid_uri}" />
      <action application="lua" data="prepaid.lua ${ccnq_account} sofia/ingress-$${profile_name}/$1@$${egress_target};location=${ccnq_location}"/>
    </condition>
  </extension>
</context>

<context name="ingress-$${profile_name}-$${profile_type}-send-call">
  <extension name="send-call">
    <condition field="${ccnq_account}" expression="^.+$"/> <!-- Must be present -->
    <condition field="destination_number" expression="^(.*)$">
      <action application="set" data="prepaid_uri=$${prepaid_uri}" />
      <action application="lua" data="prepaid.lua ${ccnq_account} sofia/egress-$${profile_name}/$1@$${ingress_target}"/>
    </condition>
  </extension>
</context>

<context name="refer-$${profile_name}-$${profile_type}-send-call">
  <extension name="send-call">
    <condition field="destination_number" expression="^(.*)$">
      <action application="bridge" data="sofia/egress-$${profile_name}/${refer_user}@${refer_domain}"/>
    </condition>
  </extension>
</context>

</section>

