#!/usr/bin/env bash
# (c) 2011 Stephane Alnet
# License: APGL3+

set -e
export LANG=
SRC="`pwd`"
DIR=/etc/ccnq3
CONF=${DIR}/host.json

./bootstrap/prepare
./bootstrap/node

HOSTNAME=`hostname`

sudo mkdir -p "${DIR}"
if [ -e "${CONF}" ]; then
  echo "** WARNING: $CONF already exists"
else
  if [ "x$1" == "x" ]; then
    echo "** Proceeding with installation of CouchDB on local host ${HOSTNAME}."

    # Using 128 or higher does not work.
    ADMIN_PASSWORD=`openssl rand 64 -hex`

    export ADMIN_PASSWORD
    . bootstrap/couchdb
    CDB_URI="http://admin:${ADMIN_PASSWORD}@${HOSTNAME}:5984"
  else
    CDB_URI="$1"
    shift
  fi

  echo "Bootstrapping database using ${CDB_URI}"
  sudo tee "${CONF}" <<JSON >/dev/null
  {
    "_id": "host:${HOSTNAME}",
    "type": "host",
    "host": "${HOSTNAME}",
    "bootstrap": true,
    "users": {
      "couchdb_uri": "${CDB_URI}/_users"
    , "userdb_base_uri": "${CDB_URI}"
    },
    "usercode": {
      "couchdb_uri": "${CDB_URI}/usercode"
    },
    "provisioning": {
      "couchdb_uri": "${CDB_URI}/provisioning"
    }
  }
JSON
fi

# Cleanup any previous run
(cd && rm -rf node_modules)

# Management of the _users database

(cd && npm install "${SRC}/"applications/roles)
(cd && npm run-script ccnq3_roles couchapps)

(cd && npm run-script ccnq3_roles stop >/dev/null 2>&1 || echo)
(cd && npm run-script ccnq3_roles start)

# Initialize the usercode database
(cd && cd "${SRC}/"applications/usercode \
    && npm install \
    && npm run-script couchapps)

# Provisioning couchapp and security
(cd && cd "${SRC}/"applications/provisioning \
    && npm install \
    && npm run-script couchapps)

# Host provisioning couchapp and security
(cd && npm install "${SRC}/"applications/host)
(cd && npm run-script ccnq3_host couchapps)


# Install the local host
(cd && npm run-script ccnq3_host bootstrap)

# Starting host service
(cd && npm run-script ccnq3_host stop >/dev/null 2>&1 || echo)
(cd && npm run-script ccnq3_host start)



# Other services are started using the "host" framework.

echo
echo "To manage your system, please access ${CDB_URI}/provisioning/_design/host/index.html or a suitable redirection."
