#!/usr/bin/env bash
# (c) 2011 Stephane Alnet
# License: APGL3+

set -e
export LANG=

./bootstrap/prepare
./bootstrap/node
# Executables
(cd && sudo npm -g install coffee-script couchapp)
# Require
(cd && npm install request couchapp)
npm install lib/cdb
npm install lib/cdb_changes

HOSTNAME=`hostname`

if [ "x$1" == "x" ]; then
  echo "** Proceeding with installation of CouchDB on local host ${HOSTNAME}."
  ./bootstrap/couchdb
  CDB_URI="http://admin:${ADMIN_PASSWORD}@${HOSTNAME}:5984/"
else
  CDB_URI="$1"
  shift
fi

echo "Bootstrapping database using ${CDB_URI}"
./applications/_users/node/security.coffee

(cd ./applications/provisioning/couchapps/ && install.sh)
./applications/provisioning/node/security.coffee

(cd ./applications/host/couchapps/ && install.sh)

echo "*** Performing local Host installation"
# What follows is a version of "bootstrap-localhost" modified for the primary system.
# Note: the bootstrap host is the only one where we will directly store the configuration.
# For all other hosts, the URI will be provided to the bootstrap-localhost script, which will
# write the configuration file itself.
echo "*** Install the host agent"
sudo npm -g install applications/host

sudo mkdir -p /etc/ccnq3
./applications/host/node/host_cli.coffee /etc/ccnq3/host.config

ccnq3_host stop || echo
ccnq3_host start

echo
echo "To manage your system, please access ${CDB_URI}/provisioning/_design/app/index.html or a suitable redirection."
