#!/usr/bin/env bash
# (c) 2011 Stephane Alnet
# License: APGL3+

set -e
export LANG=
SRC="`pwd`"

./bootstrap/prepare
./bootstrap/node
# Executables
(cd && sudo npm -g install coffee-script)

HOSTNAME=`hostname`

if [ "x$1" == "x" ]; then
  echo "** Proceeding with installation of CouchDB on local host ${HOSTNAME}."
  ./bootstrap/couchdb
  CDB_URI="http://admin:${ADMIN_PASSWORD}@${HOSTNAME}:5984/"
else
  CDB_URI="$1"
  shift
fi

echo "Bootstrapping database using ${CDB_URI}"
sudo mkdir -p /etc/ccnq3
sudo tee /etc/ccnq3/bootstrap.config <<"JSON" >/dev/null
{
  "couchdb_uri": "${CDB_URI}"
}
JSON

(cd && npm install "${SRC}/"applications/_users)
(cd && npm run-script security ccqn3_users)

(cd && npm install "${SRC}/"applications/provisioning)
(cd && npm run-script couchapps ccnq3_provisioning)
(cd && npm run-script security  ccnq3_provisioning)

(cd && npm install "${SRC}/"applications/host)
(cd && npm run-script couchapps ccnq3_host)
(cd && npm run-script bootstrap ccnq3_host)

ccnq3_host stop || echo
ccnq3_host start

echo
echo "To manage your system, please access ${CDB_URI}/provisioning/_design/app/index.html or a suitable redirection."
