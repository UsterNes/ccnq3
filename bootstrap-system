#!/usr/bin/env bash
# (c) 2011 Stephane Alnet
# License: APGL3+

set -e
export LANG=
SRC="`pwd`"

./bootstrap/prepare
./bootstrap/node
# Executables
(cd && sudo npm -g install coffee-script)

HOSTNAME=`hostname`

sudo mkdir -p /etc/ccnq3
if [ -e /etc/ccnq3/bootstrap.config ]; then
  echo "** WARNING: bootstrap.config already exists, re-using it"
else
  if [ "x$1" == "x" ]; then
    echo "** Proceeding with installation of CouchDB on local host ${HOSTNAME}."
    ./bootstrap/couchdb
    CDB_URI="http://admin:${ADMIN_PASSWORD}@${HOSTNAME}:5984/"
  else
    CDB_URI="$1"
    shift
  fi

  echo "Bootstrapping database using ${CDB_URI}"
  sudo tee /etc/ccnq3/bootstrap.config <<"JSON" >/dev/null
  {
    "couchdb_uri": "${CDB_URI}"
  }
JSON
fi

if [ -e /etc/ccnq3/host.config ]; then
  echo "** WARNING: This host has already been bootstrapped. Configuration will be overwritten."
fi

(cd && npm install "${SRC}/"applications/_users)
(cd && npm run-script security ccqn3_users)

(cd && npm install "${SRC}/"applications/provisioning)
(cd && npm run-script couchapps ccnq3_provisioning)
(cd && npm run-script security  ccnq3_provisioning)

(cd && npm install "${SRC}/"applications/host)
(cd && npm run-script couchapps ccnq3_host)
(cd && npm run-script bootstrap ccnq3_host)

ccnq3_host stop || echo
ccnq3_host start

echo
echo "To manage your system, please access ${CDB_URI}/provisioning/_design/app/index.html or a suitable redirection."
