#!/usr/bin/env bash
# (c) 2011 Stephane Alnet
# License: APGL3+

set -e
export LANG=
SRC="`pwd`"
DIR=/etc/ccnq3
CONF=${DIR}/host.json

./bootstrap/prepare
./bootstrap/node
# Executables
(cd && sudo npm -g install coffee-script)

HOSTNAME=`hostname`

sudo mkdir -p "${DIR}"
if [ -e "${CONF}" ]; then
  echo "** WARNING: $CONF already exists, re-using it"
else
  if [ "x$1" == "x" ]; then
    echo "** Proceeding with installation of CouchDB on local host ${HOSTNAME}."
    ./bootstrap/couchdb
    CDB_URI="http://admin:${ADMIN_PASSWORD}@${HOSTNAME}:5984/"
  else
    CDB_URI="$1"
    shift
  fi

  echo "Bootstrapping database using ${CDB_URI}"
  sudo tee "${CONF}" <<"JSON" >/dev/null
  {
    "_id": "host:${HOSTNAME}",
    "type": "host",
    "host": "${HOSTNAME}",
    "bootstrap": {
      "couchdb_uri": "${CDB_URI}"
    },
    "users": {
      "couchdb_uri": "${CDB_URI}/_users"
    },
    "provisioning": {
      "couchdb_uri": "${CDB_URI}/provisioning"
    },
    "databases": {
      "couchdb_uri": "${CDB_URI}/databases"
    },
    "logger": {
      "couchdb_uri": "${CDB_URI}/logger"
    }
  }
JSON
fi

(cd && npm install "${SRC}/"applications/_users)
(cd && npm run-script ccnq3_users security)

(cd && npm install "${SRC}/"applications/provisioning)
(cd && npm run-script ccnq3_provisioning couchapps)
(cd && npm run-script ccnq3_provisioning security )

(cd && npm install "${SRC}/"applications/host)
(cd && npm run-script ccnq3_host couchapps)
(cd && npm run-script ccnq3_host bootstrap)

ccnq3_host stop || echo
ccnq3_host start

echo
echo "To manage your system, please access ${CDB_URI}/provisioning/_design/app/index.html or a suitable redirection."
