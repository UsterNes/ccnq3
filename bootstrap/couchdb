#!/bin/bash

set -e
export LANG=

# CouchDBInstall
echo '*** BEGIN Install CouchDB'

# CouchDB 1.1.0 is only in unstable as of 2011-08-23.
sudo aptitude install -y couchdb

# Install default config file
# XXX Use /etc/couchdb/local.d instead?
sudo tee /etc/couchdb/local.ini <<'EOT' >/dev/null
[httpd]
port = 5984
bind_address = ::
WWW-Authenticate = Basic realm="couchdb"

[couch_httpd_auth]
require_valid_user = true

[log]
level = error

[admins]
EOT

# Add authentication, etc.
cd
ADMIN_PASSWORD=`openssl rand 256 -hex`
echo "admin = ${ADMIN_PASSWORD}" | sudo tee -a /etc/couchdb/local.ini >/dev/null

sudo /etc/init.d/couchdb restart

echo '*** END Install CouchDB Completed OK.'

